# Load required libraries
library(shiny)
library(bs4Dash)
library(plotly)
library(DT)
library(lubridate)
library(dplyr)
library(bslib)
library(tidyr)
library(thematic)
library(ggplot2)

# Load Data dari CSV
data_keluhan <- tryCatch({
  read.csv("data_keluhan_dnd.csv")
}, error = function(e) {
  # Jika gagal load, tampilkan pesan error dan gunakan data dummy sebagai pengganti
  message("Gagal memuat data: ", e)
  NULL   
})

# Data preprocessing
if (!is.null(data_keluhan)) {
  data_keluhan$Tanggal <- as.Date(data_keluhan$Tanggal)
  data_keluhan$Bulan <- format(data_keluhan$Tanggal, "%B")
  data_keluhan$Bulan <- factor(data_keluhan$Bulan, levels = month.name)  # Urutan bulan
  data_keluhan$Batas_SLA <- data_keluhan$Tanggal + 3
}

# Header
header <- dashboardHeader(
  title = "Dashboard Kinerja Agen",
  skin = "light"
)

# Sidebar
sidebar <- dashboardSidebar(
  skin = "light",
  sidebarMenu(
    menuItem("Overview", tabName = "overview", icon = icon("chart-line")),
    menuItem("Complaints Analytics", tabName = "complaints_analytics", icon = icon("chart-pie")),
    menuItem("SLA Monitoring", tabName = "sla_monitoring", icon = icon("tachometer-alt")),
    menuItem("Agent Performance", tabName = "agent_performance", icon = icon("users")),
    menuItem("Reports", tabName = "reports", icon = icon("file-alt"))
  )
)

# Body
body <- dashboardBody(
  # Custom styling
  tags$head(
    tags$style(HTML("
      body {background-color: #FFEBEE;}
      .box {background-color: #FFCDD2; border-radius: 10px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);}
      .main-sidebar {background-color: #F8BBD0;}
      .main-header .navbar {background-color: #F48FB1;}
      .value-box {background-color: #E1BEE7; color: #333333; border-radius: 10px;}
    "))
  ),
  
  tabItems(
    # Tab 1: Overview
    tabItem(
      tabName = "overview",
      fluidRow(
        box(
          title = "Welcome!",
          status = "primary",
          solidHeader = TRUE,
          width = 12,
          align = "center",
          div(class = "welcome-box",
              span(class="welcome-icon", icon("smile-wink")),
              "Selamat datang di dashboard customer service! Gunakan menu di samping untuk navigasi."
          )
        )
      ),
      fluidRow(
        valueBoxOutput("total_keluhan_box", width = 4),
        valueBoxOutput("penyelesaian_keluhan_box", width = 4),
        valueBoxOutput("waktu_respon_box", width = 4)
      ),
      fluidRow(
        valueBoxOutput("sla_compliance_box", width = 4),
        valueBoxOutput("csat_score_box", width = 4),
        valueBoxOutput("nps_score_box", width = 4)
      ),
      fluidRow(
        box(
          title = "Grafik Tren Keluhan Bulanan per Kategori",
          elevation = 4,
          plotlyOutput("grafik_tren_keluhan"),
          width = 12
        )
      )
    ),
    
    # Tab 2: Complaints Analytics
    tabItem(
      tabName = "complaints_analytics",
      fluidRow(
        box(
          title = "Distribusi Kategori Keluhan",
          elevation = 4,
          plotlyOutput("pie_chart_keluhan"),
          width = 6
        ),
        box(
          title = "Frekuensi Keluhan per Produk",
          plotlyOutput("bar_chart_produk"),
          width = 6
        )
      ),
      fluidRow(
        box(
          title = "Tabel Keluhan",
          dataTableOutput("summary_report"),
          width = 12
        ),
        downloadButton("download_report", "Download Report")
      )
    ),
    
    # Tab 3: SLA Monitoring
    tabItem(
      tabName = "sla_monitoring",
      fluidRow(
        # Value Box - SLA Compliance
        valueBoxOutput("sla_compliance_box", width = 4)
      ),
      fluidRow(
        # Alert - Keluhan Hampir Melewati SLA
        box(
          title = "Keluhan yang Hampir Melewati SLA",
          status = "warning",
          solidHeader = TRUE,
          dataTableOutput("keluhan_hampir_sla"),
          width = 12
        )
      ),
      fluidRow(
        # Grafik - SLA per Kategori Keluhan
        box(
          title = "Grafik SLA per Kategori Keluhan",
          plotlyOutput("grafik_sla_kategori"),
          width = 12
        )
      )
    ),
    
    # Tab 4: Agent Performance
    tabItem(
      tabName = "agent_performance",
      fluidRow(
        box(
          title = "Kinerja Agen",
          elevation = 4,
          dataTableOutput("performance_agen"),
          width = 12
        )
      )
    )
  )
)

# UI
ui <- dashboardPage(
  header = header,
  sidebar = sidebar,
  body = body
)

# Server
server <- function(input, output, session) {
  # Load data keluhan dari CSV sebagai reactive value
  complaints_data <- reactiveVal(data_keluhan)
  
  observe({
    # Summary Data
    total_keluhan <- nrow(complaints_data())
    rata2_penyelesaian_keluhan <- mean(complaints_data()$Persentase_Penyelesaian, na.rm = TRUE)
    rata2_waktu_respon <- mean(complaints_data()$Waktu_Respon, na.rm = TRUE)
    rata2_sla <- mean(complaints_data()$Persentase_Penyelesaian, na.rm = TRUE)
    rata2_csat <- mean(complaints_data()$Rating_CSAT, na.rm = TRUE)
    rata2_nps <- mean(complaints_data()$NPS_Score, na.rm = TRUE)
    
    # Value Boxes
    output$total_keluhan_box <- renderValueBox({
      valueBox(value = total_keluhan, subtitle = "Total Keluhan", color = "warning", icon = icon("exclamation-triangle"))
    })
    
    output$penyelesaian_keluhan_box <- renderValueBox({
      valueBox(value = paste0(round(rata2_penyelesaian_keluhan * 100), "%"), subtitle = "Tingkat Penyelesaian", color = "success", icon = icon("check-circle"))
    })
    
    output$waktu_respon_box <- renderValueBox({
      valueBox(value = round(rata2_waktu_respon, 2), subtitle = "Waktu Respon Rata-rata (Jam)", color = "primary", icon = icon("clock"))
    })
    
    output$sla_compliance_box <- renderValueBox({
      valueBox(value = paste0(round(rata2_sla * 100), "%"), subtitle = "SLA Compliance", color = "purple", icon = icon("thumbs-up"))
    })
    
    output$csat_score_box <- renderValueBox({
      valueBox(value = round(rata2_csat, 1), subtitle = "CSAT Score", color = "info", icon = icon("smile"))
    })
    
    output$nps_score_box <- renderValueBox({
      valueBox(value = round(rata2_nps, 1), subtitle = "NPS Score", color = "danger", icon = icon("heart"))
    })
  })
  
  # Grafik Tren Keluhan Bulanan per Kategori
  output$grafik_tren_keluhan <- renderPlotly({
    data_tren <- complaints_data() %>%
      mutate(Bulan = format(as.Date(Tanggal), "%Y-%m")) %>%
      group_by(Bulan, Keluhan) %>%
      summarise(Jumlah_Keluhan = n(), .groups = 'drop') %>%
      pivot_wider(names_from = Keluhan, values_from = Jumlah_Keluhan, values_fill = 0)
    
    plot_ly(data = data_tren, x = ~Bulan, type = 'bar') %>%
      add_bars(y = ~`Kurir tidak ramah`, name = 'Kurir tidak ramah') %>%
      add_bars(y = ~`Pengemasan buruk`, name = 'Pengemasan buruk') %>%
      add_bars(y = ~`Pembayaran bermasalah`, name = 'Pembayaran bermasalah') %>%
      add_bars(y = ~`Pengiriman lambat`, name = 'Pengiriman lambat') %>%
      add_bars(y = ~`Layanan pelanggan buruk`, name = 'Layanan pelanggan buruk') %>%
      add_bars(y = ~`Produk rusak`, name = 'Produk rusak') %>%
      add_bars(y = ~`Produk tidak sesuai`, name = 'Produk tidak sesuai') %>%
      add_bars(y = ~`Salah kirim barang`, name = 'Salah kirim barang') %>%
      add_bars(y = ~`Komunikasi tidak jelas`, name = 'Komunikasi tidak jelas') %>%
      layout(title = "Grafik Tren Keluhan per Kategori", 
             xaxis = list(title = "Bulan"), 
             yaxis = list(title = "Jumlah Keluhan"), 
             barmode = 'group')
  })
  
  # Pie Chart Keluhan
  output$pie_chart_keluhan <- renderPlotly({
    data_pie <- complaints_data() %>%
      group_by(Keluhan) %>%
      summarise(Jumlah = n(), .groups = 'drop')
    
    plot_ly(data = data_pie, labels = ~Keluhan, values = ~Jumlah, type = 'pie') %>%
      layout(title = "Distribusi Kategori Keluhan")
  })
  

  # Bar Chart - Frekuensi Keluhan per Produk with Automatic Color Assignment
  output$bar_chart_produk <- renderPlotly({
    data_produk <- data_keluhan %>%
      group_by(Produk_Terkait) %>%
      summarise(Jumlah_Keluhan = n()) %>%
      arrange(desc(Jumlah_Keluhan))
    
    # Use 'color' to differentiate each product category
    plot_ly(data = data_produk, 
            x = ~Produk_Terkait, 
            y = ~Jumlah_Keluhan, 
            type = 'bar', 
            color = ~Produk_Terkait,  # This ensures each product has a unique color
            colors = c("makeup" = "#f34c9d", "skincare" = "#f7c8dc", 
                       "haircare" = "#fba37f", "bodycare" = "#c7cefc", "alat makeup" = "orange")) %>%  # Customize colors for each product
      layout(title = "Frekuensi Keluhan per Produk", 
             xaxis = list(title = "Produk"), 
             yaxis = list(title = "Jumlah Keluhan"))
  })
  
  output$summary_report <- renderDataTable({
    datatable(
      complaints_data(),
      options = list(
        autoWidth = TRUE,
        scrollX = TRUE,
        pageLength = 10,
        dom = 'Bfrtip',
        buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
        columnDefs = list(list(width = '20%', targets = c(0, 1)))  # Setel lebar kolom tertentu
      ),
      caption = "Ringkasan Keluhan",
      rownames = FALSE
    )
  })
  
  
  # Download Report
  output$download_report <- downloadHandler(
    filename = function() {
      paste("laporan_keluhan_", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(complaints_data(), file, row.names = FALSE)
    }
  )
  
  # SLA MONITORING
  observe({
    sla_data <- complaints_data() %>%
      mutate(SLA_Compliant = ifelse(Tanggal + 3 >= Sys.Date() & Status_Keluhan == "Selesai", 1, 0))
    
    sla_compliance <- round(mean(sla_data$SLA_Compliant, na.rm = TRUE) * 100, 2)
    
    # SLA Compliance Value Box
    output$sla_compliance_box <- renderValueBox({
      valueBox(
        paste0(sla_compliance, "%"),
        subtitle = "SLA Compliance",
        color = "purple",
        icon = icon("thumbs-up")
      )
    })
    
    # Table for Keluhan Hampir Melewati SLA
    output$keluhan_hampir_sla <- renderDataTable({
      hampir_sla <- sla_data %>%
        filter(Status_Keluhan != "Selesai" & Batas_SLA <= Sys.Date() + 3) %>%
        select(Tanggal, Keluhan, Produk_Terkait, Agen, Batas_SLA)
      
      datatable(hampir_sla, options = list(pageLength = 5, dom = 'tip'), caption = "Keluhan yang mendekati SLA")
    })
    
    # SLA per Kategori Keluhan Chart
    output$grafik_sla_kategori <- renderPlotly({
      sla_kategori <- sla_data %>%
        group_by(Keluhan) %>%
        summarise(Percentage_SLA_Compliant = mean(SLA_Compliant, na.rm = TRUE) * 100)
      
      plot_ly(data = sla_kategori, x = ~Keluhan, y = ~Percentage_SLA_Compliant, type = 'bar') %>%
        layout(title = "Persentase SLA per Kategori Keluhan", xaxis = list(title = "Kategori Keluhan"), yaxis = list(title = "Persentase SLA Compliance"))
    })
  })
  
 
  # Kinerja Agen
  output$performance_agen <- renderDataTable({
    agen_summary <- complaints_data() %>%
      group_by(Agen) %>%
      summarise(Keluhan_Terselesaikan = sum(Status_Keluhan == "Selesai", na.rm = TRUE))
    
    datatable(
      agen_summary,
      options = list(pageLength = 5, dom = 'tip'),
      caption = "Kinerja Penyelesaian Keluhan oleh Agen"
    )
  })
  }
  

# Jalankan aplikasi
shinyApp(ui = ui, server = server)

